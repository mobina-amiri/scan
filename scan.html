<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>اسکن تاریخ انقضا → ESP8266</title>
  <style>
    body { font-family: sans-serif; margin:16px; }
    #video { width: 100%; max-width: 480px; background:#000; }
    .row { margin:8px 0; }
    .ok { color: green; }
    .warn { color: #c09000; }
    .err { color: #b00020; }
    code { background:#f5f5f5; padding:2px 4px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>اسکن بارکد و ارسال تاریخ انقضا به ESP8266</h1>

  <div class="row">
    <label>Device ID: </label>
    <input id="deviceId" value="esp8266-lamps-001" style="width:240px" />
  </div>

  <div class="row">
    <button id="btnStart">شروع اسکن</button>
    <span id="status" class="warn">در انتظار شروع…</span>
  </div>

  <video id="video" playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div class="row">
    <strong>نتیجه:</strong>
    <div>بارکد: <code id="raw"></code></div>
    <div>تاریخ انقضا: <code id="expiry"></code></div>
    <div>روزهای مانده: <code id="days"></code></div>
    <div>وضعیت ارسال: <span id="sent"></span></div>
  </div>

  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <script>
  // ====== تنظیمات MQTT ======
  const MQTT_WSS_URL = 'wss://broker.hivemq.com:8000/mqtt'; // تست با بروکر عمومی
  const MQTT_USER = '';   // برای HiveMQ public خالی است
  const MQTT_PASS = '';
  
  // ====== Device ID ======
  const DEFAULT_DEVICE_ID = 'esp8266-lamps-001';

  // ====== اتصال MQTT ======
  const client = mqtt.connect(MQTT_WSS_URL, {
    username: MQTT_USER || undefined,
    password: MQTT_PASS || undefined,
    clean: true,
    reconnectPeriod: 2000,
    connectTimeout: 10000
  });

  client.on('connect', () => {
    document.getElementById('status').textContent = 'MQTT وصل شد ✔️';
    document.getElementById('status').className = 'ok';
  });
  client.on('reconnect', () => {
    document.getElementById('status').textContent = 'در حال تلاش برای اتصال MQTT…';
    document.getElementById('status').className = 'warn';
  });
  client.on('error', (err) => {
    document.getElementById('status').textContent = 'خطای MQTT: ' + err.message;
    document.getElementById('status').className = 'err';
  });

  // ====== اسکنر بارکد ======
  const video = document.getElementById('video');
  const codeReader = new ZXing.BrowserMultiFormatReader();
  const $raw = document.getElementById('raw');
  const $expiry = document.getElementById('expiry');
  const $days = document.getElementById('days');
  const $sent = document.getElementById('sent');

  document.getElementById('btnStart').addEventListener('click', async () => {
    try {
      document.getElementById('status').textContent = 'در حال دسترسی به دوربین…';
      document.getElementById('status').className = 'warn';

      // دوربین پیش‌فرض را مستقیم باز می‌کنیم
      codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
        if (result) handleBarcode(result.getText());
        if (err && !(err instanceof ZXing.NotFoundException)) console.error(err);
      });

      document.getElementById('status').textContent = 'اسکن فعال است. بارکد را جلوی دوربین بگیرید.';
      document.getElementById('status').className = 'ok';
    } catch(e) {
      document.getElementById('status').textContent = 'عدم دسترسی به دوربین یا خطا: ' + e.message;
      document.getElementById('status').className = 'err';
    }
  });

  // ====== توابع ======

  // استخراج تاریخ از GS1 AI=17 (YYMMDD)
  function parseGs1Expiry(raw) {
    const m1 = raw.match(/\(17\)\s?(\d{6})/);
    if (m1) return yymmddToISO(m1[1]);
    const m2 = raw.match(/(?:^|[^0-9])17(\d{6})/);
    if (m2) return yymmddToISO(m2[1]);
    return null;
  }

  function yymmddToISO(yymmdd){
    const yy = parseInt(yymmdd.slice(0,2),10);
    const mm = String(parseInt(yymmdd.slice(2,4),10)).padStart(2,'0');
    const dd = String(parseInt(yymmdd.slice(4,6),10)).padStart(2,'0');
    const yyyy = 2000 + parseInt(yymmdd.slice(0,2),10);
    return `${yyyy}-${mm}-${dd}`;
  }

  function daysUntil(dateISO){
    const now = new Date();
    const tgt = new Date(dateISO + 'T12:00:00Z');
    const diffMs = tgt.getTime() - now.getTime();
    return Math.round(diffMs / (1000*60*60*24));
  }

  function handleBarcode(text){
    $raw.textContent = text;

    const expiryISO = parseGs1Expiry(text);
    if(!expiryISO){
      $expiry.textContent = 'یافت نشد (AI 17 وجود ندارد)';
      $expiry.parentElement.className = 'err';
      $sent.textContent = '—';
      return;
    }

    $expiry.textContent = expiryISO;
    $expiry.parentElement.className = '';

    const dleft = daysUntil(expiryISO);
    $days.textContent = String(dleft);

    const deviceId = document.getElementById('deviceId').value.trim() || DEFAULT_DEVICE_ID;
    const topic = `devices/${deviceId}/expiry`;
    const payload = JSON.stringify({ expiry: expiryISO, daysLeft: dleft, productCode: text });

    client.publish(topic, payload, { qos: 0, retain: true }, (err)=>{
      if(err){
        $sent.textContent = 'خطا در ارسال MQTT: ' + err.message;
        $sent.className = 'err';
      } else {
        $sent.textContent = `ارسال شد به ${topic}`;
        $sent.className = 'ok';
      }
    });
  }
  </script>
</body>
</html>
