<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>اسکن تاریخ انقضا → ESP8266</title>
  <style>
    body { font-family: sans-serif; margin:16px; }
    #video { width: 100%; max-width: 480px; background:#000; }
    .row { margin:8px 0; }
    .ok { color: green; }
    .warn { color: #c09000; }
    .err { color: #b00020; }
    code { background:#f5f5f5; padding:2px 4px; border-radius:4px; font-size:1.2em; }
    #raw { font-size:1.5em; font-weight:bold; }
  </style>
</head>
<body>
  <h1>اسکن تاریخ انقضا و ارسال به ESP8266</h1>

  <div class="row">
    <label>Device ID: </label>
    <input id="deviceId" value="esp8266-lamps-001" style="width:240px" />
  </div>

  <div class="row">
    <button id="btnStart">شروع اسکن</button>
    <span id="status" class="warn">در انتظار شروع…</span>
  </div>

  <video id="video" playsinline></video>

  <div class="row">
    <strong>نتیجه:</strong>
    <div>بارکد / تاریخ انقضا: <code id="raw"></code></div>
    <div>روزهای مانده: <code id="days"></code></div>
    <div>وضعیت ارسال: <span id="sent"></span></div>
  </div>

  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <!-- moment-jalaali -->
  <script src="https://cdn.jsdelivr.net/npm/moment-jalaali/build/moment-jalaali.js"></script>

  <script>
  // ====== تنظیمات MQTT ======
  const MQTT_WSS_URL = 'wss://broker.hivemq.com:8000/mqtt';
  const MQTT_USER = '';
  const MQTT_PASS = '';
  const DEFAULT_DEVICE_ID = 'esp8266-lamps-001';

  // اتصال MQTT
  const client = mqtt.connect(MQTT_WSS_URL, {
    username: MQTT_USER || undefined,
    password: MQTT_PASS || undefined,
    clean: true,
    reconnectPeriod: 2000,
    connectTimeout: 10000
  });

  client.on('connect', () => {
    document.getElementById('status').textContent = 'MQTT وصل شد ✔️';
    document.getElementById('status').className = 'ok';
  });
  client.on('reconnect', () => {
    document.getElementById('status').textContent = 'در حال تلاش برای اتصال MQTT…';
    document.getElementById('status').className = 'warn';
  });
  client.on('error', (err) => {
    document.getElementById('status').textContent = 'خطای MQTT: ' + err.message;
    document.getElementById('status').className = 'err';
  });

  // اسکنر بارکد
  const video = document.getElementById('video');
  const codeReader = new ZXing.BrowserMultiFormatReader();
  const $raw = document.getElementById('raw');
  const $days = document.getElementById('days');
  const $sent = document.getElementById('sent');

  document.getElementById('btnStart').addEventListener('click', async () => {
    try {
      document.getElementById('status').textContent = 'در حال دسترسی به دوربین…';
      document.getElementById('status').className = 'warn';

      // دوربین پیش‌فرض موبایل
      codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
        if (result) handleBarcode(result.getText());
        if (err && !(err instanceof ZXing.NotFoundException)) console.error(err);
      });

      document.getElementById('status').textContent = 'اسکن فعال است. بارکد را جلوی دوربین بگیرید.';
      document.getElementById('status').className = 'ok';
    } catch(e) {
      document.getElementById('status').textContent = 'عدم دسترسی به دوربین یا خطا: ' + e.message;
      document.getElementById('status').className = 'err';
    }
  });

  // تبدیل تاریخ شمسی به میلادی و محاسبه روزهای مانده
  function daysUntilJalali(jalaliDateStr){
    const m = moment(jalaliDateStr, 'jYYYY/jMM/jDD', true); // فرمت صحیح
    if(!m.isValid()) return '-';
    const now = moment();
    const diff = m.diff(now, 'days');
    return diff;
  }

  function handleBarcode(text){
    const expiry = text.trim();
    $raw.textContent = expiry;

    const dleft = daysUntilJalali(expiry);
    $days.textContent = dleft;

    const deviceId = document.getElementById('deviceId').value.trim() || DEFAULT_DEVICE_ID;
    const topic = `devices/${deviceId}/expiry`;
    const payload = JSON.stringify({ expiry: expiry, daysLeft: dleft, productCode: expiry });

    client.publish(topic, payload, { qos: 0, retain: true }, (err)=>{
      if(err){
        $sent.textContent = 'خطا در ارسال MQTT: ' + err.message;
        $sent.className = 'err';
      } else {
        $sent.textContent = `ارسال شد به ${topic}`;
        $sent.className = 'ok';
      }
    });
  }
  </script>
</body>
</html>
